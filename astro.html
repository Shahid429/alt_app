<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Stream Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/controls.min.css" crossorigin="anonymous">
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #player-container {
            height: 100%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
        }

        .shaka-video-container {
            height: 100%;
            width: 100%;
        }

        video {
            height: 100%;
            width: 100%;
        }

        .shaka-spinner-container { 
            display: none; 
        }
    </style>
</head>
<body>
    <div id="player-container">
        <div data-shaka-player-container class="shaka-video-container">
            <video autoplay data-shaka-player id="video" poster="#"></video>
        </div>
    </div>
    <script defer src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>

    <script>
        var initApp = (function() {
            var _0x2c7f = [
                'video',
                'getElementById',
                '[data-shaka-player-container]',
                'querySelector',
                'getNetworkingEngine',
                'registerRequestFilter',
                'addEventListener',
                'error',
                'load',
                'configure',
                'Player',
                'Overlay',
                'ui',
                'polyfill',
                'installAll',
                'isBrowserSupported'
            ];

            function _0x1e5c(d, e) {
                var f = _0x2c7f[d - 0];
                return f;
            }

            return async function initPlayer() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const path = urlParams.get('path');
                    const response = await fetch('config.json');
                    const config = await response.json();
                    const manifestUri = config[path];

                    shaka[_0x1e5c(13)][_0x1e5c(14)]();

                    if (shaka[_0x1e5c(10)][_0x1e5c(15)]()) {
                        const video = document[_0x1e5c(1)](_0x1e5c(0));
                        const container = document[_0x1e5c(3)](_0x1e5c(2));

                        const player = new shaka.Player(video);
                        const ui = new shaka[_0x1e5c(12)][_0x1e5c(11)](player, container, video);

                        // Configure player
                        player[_0x1e5c(9)]({
                            streaming: {
                                bufferingGoal: 60,
                                rebufferingGoal: 30,
                                bufferBehind: 30,
                                retryParameters: {
                                    timeout: 0,
                                    maxAttempts: 5,
                                    baseDelay: 1000,
                                    backoffFactor: 2,
                                    fuzzFactor: 0.5
                                }
                            },
                            manifest: {
                                retryParameters: {
                                    timeout: 0,
                                    maxAttempts: 5,
                                    baseDelay: 1000,
                                    backoffFactor: 2,
                                    fuzzFactor: 0.5
                                },
                                dash: {
                                    ignoreSuggestedPresentationDelay: true,
                                    clockSyncUri: ''
                                }
                            },
                            abr: {
                                enabled: true,
                                defaultBandwidthEstimate: 1000000,
                                switchInterval: 1
                            }
                        });

                        // Add network filters
                        player[_0x1e5c(4)]()[_0x1e5c(5)]((type, request) => {
                            request.allowCrossSiteCredentials = false;
                            request.headers = {
                                'Origin': null,
                                'Referer': '',
                                'Access-Control-Allow-Origin': '*'
                            };
                        });

                        // Error handling
                        player[_0x1e5c(6)](_0x1e5c(7), (event) => {
                            console.error('Error code', event.detail.code, 'object', event.detail);
                        });

                        // Load content
                        await player[_0x1e5c(8)](manifestUri);
                        
                        // Configure UI
                        const config = {
                            addBigPlayButton: true,
                            addSeekBar: true,
                            controlPanelElements: [
                                'play_pause',
                                'time_and_duration',
                                'spacer',
                                'mute',
                                'volume',
                                'quality',
                                'fullscreen',
                            ],
                            overflowMenuButtons: [
                                'quality',
                                'captions',
                                'language',
                                'picture_in_picture'
                            ]
                        };
                        ui.configure(config);

                        console.log('Player initialized');
                    }
                } catch (error) {
                    console.error('Error initializing player:', error);
                }
            };
        })();

        // Initialize when document is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
